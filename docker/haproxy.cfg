global
    log stdout format raw local0

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000
    
    # Enable HTTP/1.1 close to ensure connection reuse where appropriate but cleaner logs
    option http-server-close

frontend http-in
    bind *:8080
    
    # ACLs for API/Streaming traffic
    # All these should go directly to the Deno API
    acl is_api path_beg /api/
    acl is_stream path_beg /stream/
    acl is_proxy path_beg /proxy
    acl is_lineup path /lineup.json
    acl is_discover path /discover.json
    acl is_epg path /epg.xml
    acl is_channels path /channels.m3u
    acl is_epg_dir path_beg /epg/

    use_backend api_backend if is_api
    use_backend api_backend if is_stream
    use_backend api_backend if is_proxy
    use_backend api_backend if is_lineup
    use_backend api_backend if is_discover
    use_backend api_backend if is_epg
    use_backend api_backend if is_channels
    use_backend api_backend if is_epg_dir

    # Default to Static Web Server
    default_backend web_backend

backend web_backend
    server web opentuner-web:80 check

backend api_backend
    # Deno API
    server api opentuner-api:8000 check
    
    # Tuning for streaming
    # Disable buffering equivalent? HAProxy doesn't buffer by default in the same way Nginx does.
    # We might want longer timeouts for streams
    timeout server 1h
