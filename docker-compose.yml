services:
  # Backend API Service
  api:
    image: ${REGISTRY:-localhost}/opentuner-api:${TAG:-latest}
    build:
      context: .
      dockerfile: docker/api.Dockerfile
    container_name: opentuner-api
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - DENO_ENV=production

  # Frontend Web Service (Static Only)
  web:
    image: ${REGISTRY:-localhost}/opentuner-web:${TAG:-latest}
    build:
      context: .
      dockerfile: docker/web.Dockerfile
    container_name: opentuner-web
    restart: unless-stopped
    depends_on:
      - api
    # No ports exposed directly, traffic comes via Ingress

    # HAProxy Ingress
  ingress:
    image: ${REGISTRY:-localhost}/opentuner-ingress:${TAG:-latest}
    build:
      context: .
      dockerfile: docker/ingress.Dockerfile
    container_name: opentuner-ingress
    restart: unless-stopped
    ports:
      - "8080:8080"
    depends_on:
      - api
      - web
